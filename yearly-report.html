<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“† Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø³Ù†ÙˆÙŠØ©</title>
  <link rel="stylesheet" href="style.css" />
  <style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Cairo', sans-serif;
  direction: rtl;
  background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 30px 15px;
  color: #000;
}

.page-container {
  max-width: 1100px;
  width: 100%;
  margin: auto;
  background: #fff;
  border-radius: 15px;
  padding: 25px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
  animation: fadeIn 0.8s ease-in-out;
}

h1, h2, h3 {
  text-align: center;
  color: #2575fc;
  margin-bottom: 20px;
}

/* âœ… Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
  font-size: 14px;
}
th, td {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: center;
}
th {
  background: #2575fc;
  color: #fff;
}
tr:nth-child(even) {
  background: #f9f9f9;
}

/* âœ… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
.stats {
  display: flex;
  justify-content: space-around;
  margin: 20px 0;
  flex-wrap: wrap;
  gap: 15px;
}
.stat-box {
  background: #f9f9f9;
  border: 2px solid #2575fc;
  border-radius: 12px;
  padding: 20px;
  width: 30%;
  min-width: 200px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  transition: transform 0.2s ease;
}
.stat-box:hover { transform: translateY(-3px); }
.stat-box h3 {
  margin-bottom: 10px;
  font-size: 15px;
  color: #2575fc;
}
.stat-box p {
  font-size: 20px;
  font-weight: bold;
  margin: 0;
  color: #333;
}

/* âœ… Ø§Ù„ÙÙ„Ø§ØªØ± */
.filters {
  display: flex;
  justify-content: space-between;
  margin-bottom: 15px;
  flex-wrap: wrap;
  gap: 10px;
}
.filters select {
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  min-width: 200px;
  font-size: 14px;
}

/* âœ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.buttons {
  display: flex;
  justify-content: center;
  gap: 15px;
  margin-top: 20px;
  flex-wrap: wrap;
}
button {
  padding: 12px 20px;
  font-size: 15px;
  font-weight: bold;
  background: linear-gradient(135deg, #2575fc, #6a11cb);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(0,0,0,0.2);
}

/* âœ… Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆØªØ§Ø¨Ù„Øª */
@media (max-width: 768px) {
  .stat-box { width: 45%; }
  .filters { flex-direction: column; align-items: flex-start; }
  .filters select { width: 100%; }
}
@media (max-width: 500px) {
  .stat-box { width: 100%; }
  table { display: block; overflow-x: auto; white-space: nowrap; }
  button { width: 100%; }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
  </style>
</head>
<body>
  <div class="page-container">
    <h1>ğŸ“† ØªÙ‚Ø±ÙŠØ± Ø³Ù†ÙˆÙŠ</h1>

    <!-- âœ… Ø§Ù„ÙÙ„Ø§ØªØ± -->
    <div class="filters">
      <select id="yearFilter"></select>
      <select id="monthFilter">
        <option value="">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
        <option value="0">ÙŠÙ†Ø§ÙŠØ±</option>
        <option value="1">ÙØ¨Ø±Ø§ÙŠØ±</option>
        <option value="2">Ù…Ø§Ø±Ø³</option>
        <option value="3">Ø£Ø¨Ø±ÙŠÙ„</option>
        <option value="4">Ù…Ø§ÙŠÙˆ</option>
        <option value="5">ÙŠÙˆÙ†ÙŠÙˆ</option>
        <option value="6">ÙŠÙˆÙ„ÙŠÙˆ</option>
        <option value="7">Ø£ØºØ³Ø·Ø³</option>
        <option value="8">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
        <option value="9">Ø£ÙƒØªÙˆØ¨Ø±</option>
        <option value="10">Ù†ÙˆÙÙ…Ø¨Ø±</option>
        <option value="11">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
      </select>
      <select id="employeeFilter"><option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option></select>
      <select id="typeFilter">
        <option value="">ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹</option>
        <option value="casual">Ø¥Ø¬Ø§Ø²Ø© Ø¹Ø§Ø±Ø¶Ø©</option>
        <option value="annual">Ø¥Ø¬Ø§Ø²Ø© Ø§Ø¹ØªÙŠØ§Ø¯ÙŠØ©</option>
        <option value="half-hour">Ù†ØµÙ Ø³Ø§Ø¹Ø©</option>
        <option value="hour">Ø³Ø§Ø¹Ø©</option>
        <option value="quarter-morning">Ø±Ø¨Ø¹ ÙŠÙˆÙ… ØµØ¨Ø§Ø­Ù‹Ø§</option>
        <option value="half-day">Ù†ØµÙ ÙŠÙˆÙ…</option>
        <option value="quarter-evening">Ø±Ø¨Ø¹ ÙŠÙˆÙ… Ù…Ø³Ø§Ø¡Ù‹</option>
      </select>
    </div>

    <!-- âœ… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div class="stats">
      <div class="stat-box"><h3>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3><p id="totalRequests">0</p></div>
      <div class="stat-box"><h3>Ø£ÙƒØ«Ø± Ù†ÙˆØ¹ Ø¥Ø°Ù†</h3><p id="topType">-</p></div>
      <div class="stat-box"><h3>Ø£ÙƒØ«Ø± Ù…ÙˆØ¸Ù Ø·Ù„Ø¨</h3><p id="topEmployee">-</p></div>
    </div>

    <!-- âœ… Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ -->
    <div id="yearly-report-container"></div>

    <!-- âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØµØ¯ÙŠØ± -->
    <div class="buttons">
      <button onclick="exportPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ù†Ø© PDF</button>
      <button onclick="exportCSV()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø³Ù†Ø© Excel</button>
      <button onclick="exportMonthPDF()">ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ PDF</button>
      <button onclick="exportMonthCSV()">ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ Excel</button>
      <button onclick="goBack()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
    </div>
  </div>

  <script type="module">
    import { db, getDocs, collection } from './firebase.js';

    // âœ… ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±
    const currentUser = JSON.parse(localStorage.getItem("currentUser"));

    let allRequests = [];

    async function loadYearlyReport() {
      const container = document.getElementById("yearly-report-container");
      container.innerHTML = "";

      const selectedYear = parseInt(document.getElementById("yearFilter").value);

      const snapshot = await getDocs(collection(db, "dailyRequests"));
      allRequests = [];
      let employeesSet = new Set();

      snapshot.forEach(doc => {
        const data = doc.data();
        const leaveDate = new Date(data.leaveDate);
        const sameYear = leaveDate.getFullYear() === selectedYear;

        if (sameYear) {
          allRequests.push(data);
          employeesSet.add(data.name);
        }
      });

      // ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      const employeeFilter = document.getElementById("employeeFilter");
      employeeFilter.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</option>';
      employeesSet.forEach(name => {
        const option = document.createElement("option");
        option.value = name;
        option.textContent = name;
        employeeFilter.appendChild(option);
      });

      renderTables();
    }

    function updateStats(filtered) {
      document.getElementById("totalRequests").textContent = filtered.length;

      let typeCount = {}, employeeCount = {};
      filtered.forEach(req => {
        typeCount[req.type] = (typeCount[req.type] || 0) + 1;
        employeeCount[req.name] = (employeeCount[req.name] || 0) + 1;
      });

      let topType = Object.entries(typeCount).sort((a,b)=>b[1]-a[1])[0];
      let topEmployee = Object.entries(employeeCount).sort((a,b)=>b[1]-a[1])[0];

      document.getElementById("topType").textContent = topType ? `${topType[0]} (${topType[1]})` : "-";
      document.getElementById("topEmployee").textContent = topEmployee ? `${topEmployee[0]} (${topEmployee[1]})` : "-";
    }

    function renderTables() {
      const container = document.getElementById("yearly-report-container");
      container.innerHTML = "";

      const employeeFilter = document.getElementById("employeeFilter").value;
      const typeFilter = document.getElementById("typeFilter").value;
      const monthFilter = document.getElementById("monthFilter").value;

      const filtered = allRequests.filter(req => {
        const d = new Date(req.leaveDate);
        return (
          (employeeFilter === "" || req.name === employeeFilter) &&
          (typeFilter === "" || req.type === typeFilter) &&
          (monthFilter === "" || d.getMonth() == monthFilter)
        );
      });

      updateStats(filtered);

      if (filtered.length === 0) {
        container.innerHTML = "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø©</p>";
        return;
      }

      const grouped = {};
      filtered.forEach(req => {
        const d = new Date(req.leaveDate);
        const month = d.getMonth();
        if (!grouped[month]) grouped[month] = [];
        grouped[month].push(req);
      });

      const months = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];

      Object.keys(grouped).sort((a,b)=>a-b).forEach(m => {
        const section = document.createElement("div");
        section.innerHTML = `
          <h3>${months[m]}</h3>
          <table>
            <thead>
              <tr>
                <th>Ø§Ù„Ù…ÙˆØ¸Ù</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø°Ù†</th>
                <th>Ø§Ù„Ø³Ø¨Ø¨</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø°Ù†</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
              </tr>
            </thead>
            <tbody>
              ${grouped[m].map(data => `
                <tr>
                  <td>${data.name}</td>
                  <td>${data.type}</td>
                  <td>${data.reason}</td>
                  <td>${data.leaveDate}</td>
                  <td>${new Date(data.createdDate).toLocaleString("ar-EG")}</td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
        container.appendChild(section);
      });
    }

    // âœ… ØªØµØ¯ÙŠØ± PDF Ù„Ù„Ø³Ù†Ø© ÙƒÙ„Ù‡Ø§
    window.exportPDF = function() { window.print(); };

    // âœ… ØªØµØ¯ÙŠØ± CSV Ù„Ù„Ø³Ù†Ø© ÙƒÙ„Ù‡Ø§
    window.exportCSV = function() {
      let csv = "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù,Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø°Ù†,Ø§Ù„Ø³Ø¨Ø¨,ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ§Ù…,ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„\n";
      const rows = document.querySelectorAll("#yearly-report-container table tbody tr");
      rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        let rowData = [];
        cols.forEach(col => rowData.push(col.innerText));
        csv += rowData.join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "yearly_requests.csv";
      link.click();
    };

    // âœ… ØªØµØ¯ÙŠØ± Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯ PDF
    window.exportMonthPDF = function() {
      const month = document.getElementById("monthFilter").value;
      if (month === "") { alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹"); return; }
      const allSections = document.querySelectorAll("#yearly-report-container > div");
      allSections.forEach((sec, idx) => {
        sec.style.display = (idx == month) ? "block" : "none";
      });
      window.print();
      allSections.forEach(sec => sec.style.display = "block");
    };

    // âœ… ØªØµØ¯ÙŠØ± Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯ CSV
    window.exportMonthCSV = function() {
      const month = document.getElementById("monthFilter").value;
      if (month === "") { alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹"); return; }
      let csv = "Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù,Ù†ÙˆØ¹ Ø§Ù„Ø¥Ø°Ù†,Ø§Ù„Ø³Ø¨Ø¨,ØªØ§Ø±ÙŠØ® Ø§Ù„Ù‚ÙŠØ§Ù…,ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„\n";
      const rows = document.querySelectorAll("#yearly-report-container > div")[month]?.querySelectorAll("tbody tr") || [];
      rows.forEach(row => {
        const cols = row.querySelectorAll("td");
        let rowData = [];
        cols.forEach(col => rowData.push(col.innerText));
        csv += rowData.join(",") + "\n";
      });
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `requests_month_${parseInt(month)+1}.csv`;
      link.click();
    };

    // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„Ø§ØªØ±
    document.getElementById("employeeFilter").addEventListener("change", renderTables);
    document.getElementById("typeFilter").addEventListener("change", renderTables);
    document.getElementById("monthFilter").addEventListener("change", renderTables);
    document.getElementById("yearFilter").addEventListener("change", loadYearlyReport);

    // âœ… Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
    window.goBack = function() { window.location.href = "manager.html"; };

    // âœ… ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³Ù†ÙˆØ§Øª (Ø¢Ø®Ø± 5 Ø³Ù†ÙˆØ§Øª + Ø§Ù„Ø­Ø§Ù„ÙŠØ©)
    function populateYears() {
      const yearSelect = document.getElementById("yearFilter");
      const currentYear = new Date().getFullYear();
      for (let y = currentYear; y >= currentYear - 5; y--) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
      }
      yearSelect.value = currentYear;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    populateYears();
    loadYearlyReport();
  </script>
</body>
</html>

